{% extends "usuarios/aprendiz/aprendiz_base.html" %}
{% block title %}Mi Ubicación en Tiempo Real{% endblock %}

{% block aprendiz_content %}
<style>
  .map-container {
    position: relative;
    width: 100%;
    max-width: 800px;
    margin: auto;
    border: 2px solid #dee2e6;
    border-radius: .25rem;
    background-color: #f8f9fa;
  }

  .location-dot {
    position: absolute;
    width: 20px;
    height: 20px;
    background-color: #39A900; /* Verde SENA */
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 0 10px rgba(57, 169, 0, 0.8);
    transform: translate(-50%, -50%); /* Centra el punto en las coordenadas */
    transition: top 1s ease-in-out, left 1s ease-in-out; /* Animación suave */
  }

  .location-dot::after {
    content: 'Tú';
    position: absolute;
    top: -25px;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 12px;
    white-space: nowrap;
  }

  /* Estilos para el plano HTML */
  .map-layout {
    position: relative;
    width: 100%;
    height: 450px; /* Altura fija para el plano */
    background-color: #6bf5d7ff; /* Color del fondo/exterior */
    padding: 20px;
    box-sizing: border-box;
  }

  .corridor {
    position: absolute;
    background-color: #808d8fff; /* Color del pasillo */
  }

  .corridor-h {
    width: 100%;
    height: 15%;
    top: 42.5%;
    left: 0;
  }

  .corridor-v {
    width: 10%;
    height: 100%;
    left: 45%;
    top: 0;
  }

  .room {
    position: absolute;
    background-color: #12be4bff;
    border: 1px solid #adb5bd;
    box-sizing: border-box;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    color: #0a0c0bff;
    text-align: center;
    transition: background-color 0.3s ease;
  }

  .room.highlight {
    background-color: #eaf6e4; /* Verde SENA claro */
    color: #2a7d00; /* Verde SENA oscuro para el texto */
    border-color: #39A900;
  }

  /* Posicionamiento de los ambientes (ejemplo) */
  #ambiente-301 { top: 5%; left: 5%; width: 35%; height: 30%; }
  #ambiente-302 { top: 5%; right: 5%; width: 35%; height: 30%; }
  #ambiente-303 { top: 65%; left: 5%; width: 15%; height: 30%; }
  #ambiente-205 { top: 65%; left: 25%; width: 15%; height: 30%; }
  #ambiente-cafeteria { bottom: 5%; right: 5%; width: 35%; height: 30%; }
  #ambiente-101 { top: 65%; left: 60%; width: 15%; height: 30%; }
</style>

<div class="card p-4 shadow-sm">
  <h5 class="mb-4">Mi Ubicación en Tiempo Real</h5>

  <!-- Buscador de Ambientes -->
  <div class="input-group mb-3 mx-auto" style="max-width: 400px;">
    <input type="text" id="searchInput" class="form-control" placeholder="Buscar ambiente por número (ej: 301, cafeteria)...">
    <button class="btn btn-success" type="button" id="searchButton"><i class="bi bi-search"></i> Buscar</button>
  </div>

  <div class="map-container">
    <!-- Plano del edificio con HTML y CSS -->
    <div class="map-layout">
      <!-- Pasillos -->
      <div class="corridor corridor-h"></div>
      <div class="corridor corridor-v"></div>
      <!-- Ambientes -->
      {% for ambiente in ambientes %}
      <div id="ambiente-{{ ambiente.id }}" class="room">{{ ambiente.nombre_display }}</div>
      {% endfor %}
      <!-- Punto de ubicación del usuario -->
      <div id="userLocation" class="location-dot" style="left: {{ posicion.x }}%; top: {{ posicion.y }}%;"></div>
    </div>
  </div>
  <p class="text-center text-muted mt-3">
    <i class="bi bi-info-circle-fill"></i>
    Este es un mapa de prueba. Tu ubicación simulada se actualizará periódicamente.
  </p>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const locationDot = document.getElementById('userLocation');
  const searchButton = document.getElementById('searchButton');
  const searchInput = document.getElementById('searchInput');

  // Simular actualización de GPS cada 5 segundos
  setInterval(() => {
    // Coordenadas aleatorias dentro del 90% del mapa para que no se salga de los bordes
    const newX = Math.random() * 90 + 5;
    const newY = Math.random() * 90 + 5;
    locationDot.style.left = `${newX}%`;
    locationDot.style.top = `${newY}%`;
  }, 5000);

  // Funcionalidad de búsqueda
  searchButton.addEventListener('click', function() {
    const query = searchInput.value.trim().toLowerCase();
    if (!query) return;

    // Quitar resaltado anterior
    const highlighted = document.querySelector('.room.highlight');
    if (highlighted) {
      highlighted.classList.remove('highlight');
    }

    // Buscar y resaltar el nuevo ambiente
    const targetRoom = document.getElementById(`ambiente-${query}`);
    if (targetRoom) {
      // Centrar la vista en el ambiente encontrado si es posible (mejora opcional)
      // targetRoom.scrollIntoView({ behavior: 'smooth', block: 'center' });
      targetRoom.classList.add('highlight');
    } else {
      alert('Ambiente no encontrado. Intenta con: 301, 302, 303, 205, 101, cafeteria.');
      // Usar un feedback visual en lugar de un alert
      searchInput.classList.add('is-invalid');
      setTimeout(() => searchInput.classList.remove('is-invalid'), 3000);
    }
  });

  // Permitir buscar con la tecla Enter
  searchInput.addEventListener('keyup', (event) => event.key === 'Enter' && searchButton.click());
});
</script>
{% endblock %}