{% extends "usuarios/instructor/instructor_base.html" %}
{% block title %}Reportes{% endblock %}
{% block instructor_content %}
<style>
  .badge-Sanción { background-color: #ffc107; color: #000; border: 1px solid #e0a800; }
  .badge-Deserción { background-color: #dc3545; color: #ffffff; border: 1px solid #bd2130; }
  .badge-Felicitación { background-color: #39A900; color: #ffffff; border: 1px solid #07b449; }
  .table-hover tbody tr:hover {
    background-color: #feffffff;
    transform: scale(1.01);
    transition: all 0.3s ease;
  }
  .btn-primary {
    background-color: #39A900;
    border-color: #39A900;
    transition: background-color 0.3s ease, border-color 0.3s ease;
  }
  .btn-primary:hover {
    background-color: #07b449;
    border-color: #07b449;
  }
  .btn-outline-secondary {
    border-color: #39A900;
    color: #39A900;
    transition: background-color 0.3s ease, color 0.3s ease;
  }
  .btn-outline-secondary:hover {
    background-color: #39A900;
    border-color: #39A900;
    color: #ffffff;
  }
  .form-select {
    border: 2px solid #39A900;
    border-radius: 6px;
    transition: border-color 0.3s ease;
  }
  .form-select:focus {
    border-color: #07b449;
    box-shadow: 0 0 8px #07b449aa;
    outline: none;
  }
  .table {
    border: 1px solid #39A900;
    border-radius: 8px;
    overflow: hidden;
  }
  .table thead th {
    background-color: #39A900;
    color: #ffffff;
    border: none;
  }
  .table tbody td {
    border-color: #39A900;
  }
  .modal-content {
    border: 2px solid #39A900;
    border-radius: 8px;
  }
  .modal-header {
    background-color: #f0f9f0;
    border-bottom: 1px solid #39A900;
  }
  .modal-footer {
    border-top: 1px solid #39A900;
  }
  .form-control {
    border: 2px solid #39A900;
    border-radius: 6px;
    transition: border-color 0.3s ease;
  }
  .form-control:focus {
    border-color: #07b449;
    box-shadow: 0 0 8px #07b449aa;
    outline: none;
  }
  h5 {
    color: #212529;
  }
</style>

<div class="card p-4 shadow-sm">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h5 class="mb-0">Reportes de Aprendices</h5>
    <div class="d-flex">
      <select class="form-select me-2" style="width: 200px;">
        <option selected>Filtrar por tipo...</option>
        {% for tipo in tipos_reporte %}
        <option value="{{ tipo }}">{{ tipo }}</option>
        {% endfor %}
      </select>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#nuevoReporteModal">Generar Nuevo</button>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-hover table-striped">
      <thead class="table-light">
        <tr>
          <th>Tipo</th>
          <th>Aprendiz</th>
          <th>Ficha</th>
          <th>Fecha</th>
          <th>Descripción</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for reporte in reportes %}
        <tr>
          <td><span class="badge badge-{{ reporte.tipo }}">{{ reporte.tipo }}</span></td>
          <td>{{ reporte.aprendiz }}</td>
          <td>{{ reporte.ficha }}</td>
          <td>{{ reporte.fecha }}</td>
          <td>{{ reporte.descripcion }}</td>
          <td><a href="{% url 'instructor_reporte_detalle' reporte.id %}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-eye-fill"></i></a></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Modal para Nuevo Reporte -->
  <div class="modal fade" id="nuevoReporteModal" tabindex="-1" aria-labelledby="nuevoReporteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form method="POST" action="{% url 'instructor_reportes' %}">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title" id="nuevoReporteModalLabel">Generar Nuevo Reporte</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="tipo_reporte" class="form-label">Tipo de Reporte</label>
              <select class="form-select" id="tipo_reporte" name="tipo_reporte" required>
                <option value="" selected disabled>Seleccione un tipo...</option>
                {% for tipo in tipos_reporte %}
                  <option value="{{ tipo }}">{{ tipo }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="ficha" class="form-label">Ficha</label>
              <select class="form-select" id="ficha" name="ficha" required>
                <option value="" selected disabled>Seleccione una ficha...</option>
                {% for ficha in fichas %}
                  <option value="{{ ficha.id }}">{{ ficha.numero }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="aprendiz" class="form-label">Aprendiz</label>
              <select class="form-select" id="aprendiz" name="aprendiz" required disabled>
                <option value="" selected disabled>Seleccione un aprendiz...</option>
                <!-- Opciones se llenarán con JS -->
              </select>
            </div>
            <div class="mb-3">
              <label for="descripcion" class="form-label">Descripción y/o Evidencias</label>
              <textarea class="form-control" id="descripcion" name="descripcion" rows="4" required></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Guardar Reporte</button>
          </div>
        </form>
      </div>
    </div>
  </div>

</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const fichaSelect = document.getElementById('ficha');
  const aprendizSelect = document.getElementById('aprendiz');
  const aprendicesData = {{ aprendices|safe }};

  fichaSelect.addEventListener('change', function () {
    const selectedFichaId = this.value;
    
    // Limpiar y deshabilitar el select de aprendices
    aprendizSelect.innerHTML = '<option value="" selected disabled>Seleccione un aprendiz...</option>';
    aprendizSelect.disabled = true;

    if (selectedFichaId) {
      const aprendicesEnFicha = aprendicesData.filter(a => a.ficha_id == selectedFichaId);
      aprendicesEnFicha.forEach(aprendiz => {
        aprendizSelect.innerHTML += `<option value="${aprendiz.id}">${aprendiz.nombre_completo}</option>`;
      });
      aprendizSelect.disabled = false;
    }
  });
});
</script>
{% endblock %}
{% endblock %}